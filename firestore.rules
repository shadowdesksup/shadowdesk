rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regras para Modelos Descritivos (Compartilhados)
    // Permite que qualquer usuário autenticado leia e escreva (Criar/Editar/Excluir)
    match /modelos_descritivos/{document=**} {
      allow read, write: if request.auth != null;
    }

    // Regras para Usuários (Perfil)
    // Regras para Usuários (Perfil)
    match /users/{userId} {
      // Permitir leitura pública (para busca)
      allow read: if request.auth != null;
      // Permitir escrita para atualizações de amigos (arrays)
      allow write: if request.auth != null;
    }

    // Regras para Solicitações de Amizade
    match /friend_requests/{requestId} {
      // Usuários envolvidos podem ler
      allow read: if request.auth != null && (
        resource.data.fromId == request.auth.uid || 
        resource.data.toId == request.auth.uid
      );
      // Qualquer um pode criar (validação de dados recomendada no app)
      allow create: if request.auth != null;
      // Usuários envolvidos podem atualizar (aceitar/recusar) ou deletar
      allow update, delete: if request.auth != null && (
        resource.data.fromId == request.auth.uid || 
        resource.data.toId == request.auth.uid
      );
    }
    
    // Regras para Registros (Chamados) - Supondo existência baseada em uso
    match /registros/{document=**} {
      allow read, write: if request.auth != null;
    }

    // Regras para Locais (Selectors)
    match /locais/{document=**} {
      allow read, write: if request.auth != null;
    }

    // Regras para Lembretes
    match /lembretes/{lembreteId} {
      // Permitir leitura se for o criador ou se foi compartilhado com o usuário
      allow read: if request.auth != null && (
        resource.data.criadoPor == request.auth.uid ||
        resource.data.compartilhadoCom == request.auth.uid
      );
      
      // Criar: qualquer autenticado (logica de validacao de dados deve ser no app ou via request.resource.data)
      allow create: if request.auth != null;
      
      // Atualizar/Deletar: apenas criador ou destinatário (para aceitar/recusar)
      allow update, delete: if request.auth != null && (
        resource.data.criadoPor == request.auth.uid ||
        resource.data.compartilhadoCom == request.auth.uid
      );
    }

    // Regras para Notificações
    match /notificacoes/{notificacaoId} {
      // Usuário só pode ler/modificar suas próprias notificações
      allow read, update, delete: if request.auth != null && (
        resource.data.userId == request.auth.uid
      );
      // Qualquer autenticado pode criar notificação (para enviar a outro usuário)
      allow create: if request.auth != null;
    }

    // Regras para Alertas Meteorológicos
    match /weatherAlerts/{userId} {
      // Usuário só pode ler/escrever seu próprio documento de alertas
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Regras para ServiceDesk Tickets (sincronizados pelo worker)
    match /serviceDesk_tickets/{ticketId} {
      // Qualquer usuário autenticado pode ler, deletar e atualizar (para marcação de 'visto')
      allow read, delete, update: if request.auth != null;
      // Criação apenas via Admin SDK
      allow create: if false;
    }

    // Regras para ServiceDesk Snapshots (debug/raw data)
    match /serviceDesk_snapshots/{snapshotId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Regras para ServiceDesk Tickets Ignorados (Blacklist)
    match /serviceDesk_ignored_tickets/{ticketId} {
      // Qualquer usuário autenticado pode adicionar/ler ignorados
      allow read, write: if request.auth != null;
    }

    // Regras para Preferências do ServiceDesk
    match /serviceDesk_preferences/{docId} {
      allow read, write: if request.auth != null;
    }
  }
}
